# Story 3.3: Server Receives and Broadcasts Updates

## Status
- [x] Draft
- [x] Approved
- [x] In Progress
- [x] Review
- [x] Done

## Story
**As a** server,
**I want** to receive position updates and broadcast them to all other clients
**so that** everyone's game is synchronized.

## Acceptance Criteria
1. Server receives 'move' messages from clients with { dx, dy, direction }.
2. Validate incoming moves: Check bounds (0 to maze size) and maze grid (path === 1).
3. If valid, update player.x, player.y, player.direction in GameState.
4. Colyseus automatically broadcasts state changes to all clients.
5. Reject invalid moves silently (no update, no broadcast).
6. Handle concurrent moves from multiple players without race conditions.

## Tasks / Subtasks
- [x] **Server:** onMessage('move') receives and validates updates.
- [x] **Server:** Updates player state and auto-broadcasts via Colyseus.
- [x] **Server:** Add logging/error handling for invalid moves (e.g., console.warn).
- [x] **Server:** Tests: Expand MazeRaceRoom.test.ts for validation, concurrent moves, rejections.

## Dev Notes
- Builds on Story 3.2: Implement in MazeRaceRoom.onMessage('move'), use flat grid indexing (newY * width + newX).
- Refer to `packages/server/rooms/MazeRaceRoom.ts` for room logic, `packages/shared/types/index.ts` for Player schema.
- Colyseus MapSchema changes trigger onChange on clients automatically.
- Ensure maze grid is set before moves (from onStartGame).
- Follow code style: TypeScript, 2-space indentation, camelCase, early returns.
- No additional messages needed; leverage schema sync.

### Testing
- Test file location: `packages/server/test/MazeRaceRoom.test.ts`
- Test standards: Jest with Colyseus mock rooms/clients (simulate 'move' messages, assert updates/rejections, concurrent via multiple mocks).
- Cover edge cases: Out-of-bounds, wall hits, valid paths, multiple players.

## Change Log
| Date       | Version | Description              | Author          |
|------------|---------|--------------------------|-----------------|
| 2025-09-17 | 1.0     | Initial story doc creation based on epic and code review. | Product Owner   |
| 2025-09-17 | 1.1     | Added logging for invalid moves and expanded tests for validation, concurrent moves, and rejections. | Full Stack Developer |