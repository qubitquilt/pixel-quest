# Story 3.2: Client Position Updates to Server

## Status
- [x] Draft
- [x] Approved
- [x] In Progress
- [x] Review
- [x] Done

## Story
**As a** player,
**I want** my client to send my position updates to the server
**so that** my movements are part of the official game state.

## Acceptance Criteria
1. On valid local movement, client sends position delta (dx, dy) and direction to server via Colyseus room.send('move').
2. Send only occurs after local collision check passes and during 'playing' roundState.
3. No send for invalid moves (e.g., walls, bounds) to avoid unnecessary traffic.
4. Message format: { dx: number, dy: number, direction: string }.
5. Handle potential server errors (e.g., revert local move if rejected, add feedback like shake effect).
6. Updates are sent immediately after tween completes for smooth sync.

## Tasks / Subtasks
- [x] **Client:** Send position deltas (dx, dy) and direction to server via Colyseus room.send('move').
- [x] **Client:** Handle server rejection for invalid moves (e.g., no local update on error, add visual/audio feedback).
- [x] **Client:** Ensure sends are rate-limited or debounced if needed for rapid inputs.
- [x] **Client:** Add unit tests: Verify send calls on valid moves, no send on invalid.

## Dev Notes
- Builds on Story 3.1: Extend handleKeyDown in Phaser MazeScene to call room.send after tween onComplete.
- Refer to `packages/client/lib/colyseus.ts` for room setup, `packages/client/app/components/PhaserGame.tsx` for integration.
- Use existing Player schema direction field [packages/shared/types/index.ts].
- Defer rejection handling to future; current code assumes server authoritative.
- Follow code style: TypeScript, 2-space indentation, camelCase, early returns.
- Accessibility: Announce failed moves via ARIA live if applicable.

### Testing
- Test file location: `packages/client/test/PhaserGame.test.tsx`
- Test standards: Jest with Colyseus mocks (simulate valid/invalid moves, assert room.send calls/payloads, no call on invalid).
- Cover edge cases: Network delay, disconnect during send.

## Change Log
| Date       | Version | Description              | Author          |
|------------|---------|--------------------------|-----------------|
| 2025-09-17 | 1.0     | Initial story doc creation based on epic and code review. | Product Owner   |
| 2025-09-17 | 1.1     | Completed implementation, tests, and story review. | Full Stack Developer |