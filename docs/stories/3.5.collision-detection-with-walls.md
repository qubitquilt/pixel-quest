# Story 3.5: Collision Detection with Walls

## Status
- [x] Draft
- [x] Approved
- [x] In Progress
- [x] Review
- [x] Done

## Story
**As a** developer,
**I need** to implement collision detection between players and maze walls
**so that** players cannot walk through them.

## Acceptance Criteria
1. Client performs pre-collision check against maze grid before attempting move or send.
2. Server performs authoritative validation on received moves against bounds and grid.
3. Invalid moves (walls=0, out-of-bounds) are rejected: No position update on client/server.
4. No visual animation for invalid local moves (prevent tween start).
5. Players stop at walls; no clipping or pass-through.
6. Edge cases handled: Corner walls, rapid inputs, concurrent collisions.

## Tasks / Subtasks
- [x] **Client:** Pre-check grid before move/send.
- [x] **Server:** Validate post-receive, reject invalid.
- [x] **Client:** Prevent animation on invalid local moves.
- [x] **Tests:** Edge cases (bounds, walls, concurrent).

## Dev Notes
- Builds on Stories 3.1 and 3.3: In handleKeyDown (client) check this.grid[newY][newX] === 1 before tween/send; in onMessage('move') (server) same with flat index.
- Refer to `packages/client/app/components/PhaserGame.tsx` for client check, `packages/server/rooms/MazeRaceRoom.ts` for server validation.
- Grid: 0=wall, 1=path; maze 21x21.
- For rejection feedback: Optional shake effect on player sprite if local invalid.
- Follow code style: TypeScript, 2-space indentation, camelCase, early returns.
- No player-player collision required (walls only).

### Testing
- Test file locations: `packages/client/test/PhaserGame.test.tsx`, `packages/server/test/MazeRaceRoom.test.ts`
- Test standards: Jest mocks for grid/input/messages (assert no update on wall/bounds, update on path; concurrent via multi-mocks).
- E2E: Playwright gameplay.spec.ts â€“ attempt wall move, assert no position change.

## Change Log
| Date       | Version | Description              | Author          |
|------------|---------|--------------------------|-----------------|
| 2025-09-17 | 1.0     | Initial story doc creation based on epic and code review. | Product Owner   |
| 2025-09-17 | 2.0     | Implemented client pre-checks, server validation, no animation on invalid moves, shake feedback, and edge case tests (corners, rapid, concurrent). All AC met. | Full Stack Developer |