# Story 4.3: Server Detects Round Winner (Treasure Overlap)

## Story ID

4.3

## Title

Server-side Winner Detection: Treasure Overlap

## Description

As a server, I want to detect when a player's position overlaps with the treasure's position so that the server can identify the round winner, broadcast a "Round Over" event, and transition the game state to a summary/round-end phase.

This story follows Stories 4.1 (local flashlight) and 4.2 (shared flashlight visibility). It is server-focused and ensures authoritative win detection, consistent round lifecycle transitions, and reliable broadcasts to all clients.

## Acceptance Criteria

1. The server stores the treasure position (x, y or cell index) in GameState when a round starts.
2. When a player's authoritative position overlaps the treasure (grid cell equality or within configurable radius), the server sets the round winner and transitions roundState to 'round_over'.
3. The server updates GameState with roundResult (winnerId, final positions, elapsedTime, provisional scores) and broadcasts the change to all clients.
4. Further move messages during round_over are ignored or rejected; the server starts a roundEndDelay timer before starting next round or ending the match.
5. Clients receive the roundState change and display a round summary UI with winner and provisional scores.
6. Unit and integration tests validate overlap detection, idempotency under concurrent moves, and correct broadcast payloads.

## Relevant PRD Excerpts

From docs/prd/epic-4-core-gameplay-mechanics-flashlight-win-condition.md:

* Story 4.3: Detect treasure overlap to identify round winner.
* Story 4.4: Broadcast "Round Over" when a winner is found.

## Relevant Architecture Excerpts

- GameState should include: maze grid, players Map, treasure position/index, roundState (idle|playing|round_over), and optional per-round timers.
- Player positions are authoritative on the server; validated moves update player positions.
- Overlap checks may use grid indices (recommended) to avoid float tolerances.

## Tasks

- [ ] Task 1: Ensure treasure position is set when a round starts
  - [ ] Subtask 1.1: MazeRaceRoom.startGame assigns treasure position to a valid path cell
- [ ] Task 2: Implement overlap detection in MazeRaceRoom
  - [ ] Subtask 2.1: On validated move updates, compare player's cell/index or distance to treasure
  - [ ] Subtask 2.2: On detected overlap and roundState === 'playing', set roundState = 'round_over' and record winner
- [ ] Task 3: Update GameState and broadcast roundResult
  - [ ] Subtask 3.1: Add roundResult schema (winnerId, positions, provisional scores)
  - [ ] Subtask 3.2: Optionally emit room.broadcast('round.over', payload)
- [ ] Task 4: Prevent further move processing during round_over
  - [ ] Subtask 4.1: MazeRaceRoom.handleMove rejects/ignores moves when roundState !== 'playing'
- [ ] Task 5: Implement simple per-round scoring hook (placeholder for Story 5.x)
- [ ] Task 6: Client updates: listen for roundState change and display round summary UI
- [ ] Task 7: Tests
  - [ ] Subtask 7.1: Unit tests for overlap math and idempotency
  - [ ] Subtask 7.2: Integration tests simulating multiple clients racing to treasure

## Dev Notes

- Use grid-cell equality (index math) when movement is cell-based to avoid floating point issues. If using pixel movement, use a small radius and server-side rounding.
- Ensure atomic winner assignment: guard with if (roundState !== 'playing') return to avoid double-winners.
- Start a configurable roundEndDelay (e.g., 3000ms) after RoundOver before starting the next round.
- Use Colyseus schema for roundResult so clients receive updates via state sync.

## Testing

- Unit tests (packages/server/test): overlap detection, roundState transition, idempotency under concurrent moves.
- Integration tests: simulate two or more clients; verify only one winner and correct broadcasted payload.
- Optional E2E: Playwright flow to visually confirm client round-summary UI after RoundOver.

## Dev Agent Record

### Agent Model Used

OpenHands BMAD microagent

### Debug Log References

- Refer to existing MazeRaceRoom unit tests and server test output (previously passing in this session).

### Completion Notes

- DRAFT: Implements authoritative server-side winner detection (treasure overlap), roundState transition, basic roundResult broadcast, and placeholder scoring hook.

### File List

- packages/server/rooms/MazeRaceRoom.ts — add treasure in GameState, overlap checks in handleMove, round over handling
- packages/shared/types/index.ts — extend GameState schema with treasure and roundResult if missing
- packages/server/test/maze-race-room.test.ts — add unit tests for overlap detection and RoundOver
- packages/client/pages/game/[roomId].tsx and packages/client/app/components/PhaserGame.tsx — listen for roundState changes and show round summary UI

### Change Log

| Version | Date | Changes | Author |
|---------|------|---------|--------|
| 1.0     | 2025-09-19 | Initial draft | SM Agent |

## Status

DRAFT

## QA Results

[Space for QA notes, gate decision: PASS/CONCERNS/FAIL/WAIVED]
