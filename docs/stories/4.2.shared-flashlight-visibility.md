# Story 4.2: Shared Flashlight Visibility

## Status
- [x] Draft
- [x] Approved
- [x] In Progress
- [x] Review
- [x] Done

## Story
**As a** player,
**I want** my flashlight cone to be visible to other players, and I want to see theirs,
**so that** we have shared visibility on the map during gameplay.

## Acceptance Criteria
1. Each player's flashlight cone is calculated and sent to the server on movement (position + direction).
2. Server broadcasts all players' cone data (pos, dir, range) to all clients via Colyseus state.
3. Client renders multiple light masks: own cone + others' cones (different colors? or same white reveal).
4. Visibility updates in real-time for all cones as players move (sync via state changes).
5. Cones overlap correctly: revealed areas union across all visible cones.
6. Performance: No lag in multi-player (limit updates, batch renders); works with 4+ players.
7. Local cone always prioritizes (own first, then others).

## Tasks / Subtasks
- [ ] **Server:** Extend MazeRaceRoom state schema: add players[].cone (x, y, direction) Schema.
- [ ] **Server:** On player move, update and broadcast cone data to all (onChange listeners).
- [ ] **Client:** In PhaserGame/MazeScene, subscribe to state changes for other players' cones.
- [ ] **Client:** Extend updateVisibility: compute/render own + all other cones' light masks (multiple Graphics or composite).
- [ ] **Client:** Handle overlaps: union visible tiles across cones before applying mask.
- [ ] **Client:** Visual diff: Own cone full white, others semi-transparent or tinted (optional, for clarity).
- [ ] **Client:** Unit tests: Mock multi-player state, verify multiple fillRect calls, union logic.
- [ ] **E2E:** Extend lobby.spec.ts or new gameplay.spec: Multi-join, move players, verify shared reveals in screenshots.

## Dev Notes
- Builds on 4.1: Reuse computeVisibleTiles for each player, but server-side calc optional (client can compute from pos/dir).
- Colyseus: Use MapSchema<PlayerState> with cone: {x, y, direction}; onChange trigger client re-render.
- Phaser: Add array of light Graphics, one per player; or single light with all visibles unioned (efficient).
- Direction sync: Already in 3.1 movement; ensure direction updates with pos.
- Range/Angle: Fixed 4/60, shared across players.
- Refer to packages/client/lib/colyseus.ts for room setup, packages/server/rooms/MazeRaceRoom.ts for state.
- Follow style: TS, 2-space, camelCase, early returns (e.g., if(!otherPlayers) return), handleKeyDown prefix.
- Accessibility: Announce shared visibility changes via ARIA live region (e.g., "Player2 cone updated").
- Defer win/treasure to 4.3; assume no blocking.

### Testing
- Test file location: `packages/client/test/PhaserGame.test.tsx`
- Test standards: Jest mocks for Colyseus state, Phaser; verify multi-cone fillRect, union (e.g., 6+ tiles visible), updates on state change.
- Cover: Single vs multi-player, cone overlaps, edge (player off-screen), perf (no >16ms/frame).

## Change Log
| Date       | Version | Description              | Author |
|------------|---------|--------------------------|--------|
| 2025-09-17 | 1.0     | Initial draft of story.  | BMad Orchestrator |
| 2025-09-17 | 1.1     | Implemented shared flashlight visibility, direction sync, cone union, visual diff, tests. | BMad Orchestrator |

## Dev Agent Record
### Debug Log References
- None.

### Completion Notes
- Shared visibility implemented with real-time cone union and visual diff. Tests pass (unit/E2E with server running). Perf ok for 4+ players.

### Agent Model Used
- openrouter/sonoma-sky-alpha

### File List
- packages/server/rooms/MazeRaceRoom.ts (modified: direction sync in onMessage)
- packages/client/app/components/PhaserGame.tsx (modified: visualCones Graphics, updateVisibility for union and diff)
- packages/client/test/PhaserGame.test.tsx (added: MazeScene tests for computeVisibleTilesFor, updatePlayer, union, visual diff)
- packages/client/e2e/gameplay.spec.ts (extended: correct selectors, navigation to /game, screenshots for reveals, 4-player perf)