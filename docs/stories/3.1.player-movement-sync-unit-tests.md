# Story 3.1: Player Movement Sync Unit Tests

**Status:** In Progress

**Story**
**As a** QA engineer,
**I want** unit tests for player movement input, server validation, and state synchronization,
**so that** multiplayer movement consistency is verified and regressions are prevented.

**Acceptance Criteria**
1. Client tests verify key input (WASD/arrows) triggers Colyseus send with position delta.
2. Server tests validate incoming movement (wall collision, bounds), broadcast updated state to all clients.
3. Client tests assert received state updates player position correctly in Phaser scene.
4. Tests cover edge cases: Invalid moves rejected, concurrent moves from multiple players.
5. Tests use mocks for Colyseus and Phaser to isolate logic.
6. Coverage for movement sync >90%.

**Tasks / Subtasks**
- [x] **Client Tests: Input and Send** (AC: 1,5)
  - [x] In packages/client/test/PhaserGame.test.tsx, add tests for keydown event -> position calculation -> room.send('move', delta).
  - [x] Mock Phaser input and Colyseus room.send to assert calls.
- [ ] **Server Tests: Validation and Broadcast** (AC: 2,4,5)
  - [ ] In packages/server/test/MazeRaceRoom.test.ts, use Colyseus testing to simulate client 'move' message.
  - [ ] Assert server validates against maze grid/bounds, updates player.x/y, broadcasts state.
  - [ ] Test concurrent joins and moves for sync.
- [ ] **Client Tests: State Update** (AC: 3,5)
  - [ ] In packages/client/test/PhaserGame.test.tsx, mock onStateChange to simulate broadcast, assert Phaser sprite updates position.
- [ ] **Coverage and Edge Cases** (AC: 4,6)
  - [ ] Add tests for invalid moves (wall hit, out of bounds) - server rejects, client no update.
  - [ ] Run jest --coverage, ensure >90% for movement code.
- [ ] **Integration Verification** (AC: 1-4)
  - [ ] Use Colyseus mock rooms to test full flow: Client send -> server process -> client receive.

**Dev Notes**
- **Previous Story Insights:** Builds on 2.3 Phaser rendering and 3.1 movement implementation; use existing maze grid for validation [Source: docs/architecture/3-data-models.md].
- **Data Models:** Player schema with x, y, startX, startY; use shared types for consistency [Source: packages/shared/types/index.ts, docs/architecture/3-data-models.md].
- **File Locations:** Client tests in packages/client/test/PhaserGame.test.tsx; server in packages/server/test/MazeRaceRoom.test.ts [Source: docs/architecture/4-unified-project-structure.md].
- **Technical Constraints:** Mock Colyseus client/room for isolation; Phaser input mocked as in existing tests [Source: docs/architecture/tech-stack.md].
- No specific API endpoints for movement; uses Colyseus messages ('move') [Source: docs/architecture/5-core-workflows.md#5.2 Player Movement].

**Testing**
- Test file location: packages/client/test/PhaserGame.test.tsx, packages/server/test/MazeRaceRoom.test.ts.
- Test standards: Jest with jsdom for client, Colyseus testing utils for server; mock dependencies, assert calls/state [Source: docs/architecture/testing-strategy.md].
- Frameworks: @testing-library/react for UI, jest.mock for Phaser/Colyseus.
- Specific requirements: Async waits for state changes; coverage threshold 90% for movement functions.

**Change Log**
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-09-10 | 1.0 | Initial draft for test story based on QA gaps. | Bob, Scrum Master |

**Dev Agent Record**

**QA Results**