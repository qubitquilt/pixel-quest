# Story 4.1: Flashlight Visibility Cone

## Status
- [x] Draft
- [x] Approved
- [x] In Progress
- [ ] Review
- [x] Done

## Story
**As a** developer,
**I want** to implement a "fog of war" or mask effect in Phaser to create the flashlight visibility cone for the local player,
**so that** players can only see a limited area around their position, simulating a flashlight.

## Acceptance Criteria
1. The maze rendering includes a fog-of-war overlay that hides all tiles except those within the local player's flashlight cone.
2. The flashlight cone is a sector (e.g., 60-degree angle) centered on the local player's position, with a limited range (e.g., 3-5 tiles).
3. The cone updates in real-time as the local player moves, revealing/hiding tiles dynamically.
4. Walls and other static elements are partially visible only within the cone; outside is fully obscured.
5. The mechanic works locally in the Phaser scene without server involvement (visibility sync deferred to Story 4.2).
6. Performance remains smooth (60 FPS) during movement and updates.

## Tasks / Subtasks
- [x] **Client:** Add a fog-of-war graphics layer or mask to the Phaser MazeScene.
- [x] **Client:** Implement flashlight cone logic: calculate visible tiles based on player position, direction, and range using raycasting or grid checks.
- [x] **Client:** Apply dynamic mask to the maze tilemap or graphics, updating on player movement.
- [x] **Client:** Ensure the local player's own sprite and immediate surroundings are always visible within the cone.
- [x] **Client:** Handle edge cases: cone at maze edges, overlapping cones (local only for now).
- [x] **Client:** Add unit tests for visibility calculation (mock grid and player pos, verify visible tiles).

## Dev Notes
- Builds on Story 3.1: Extend PhaserGame and MazeScene with visibility layer.
- Use Phaser.Graphics for fog overlay or BitmapMask for tilemap; draw black circle with cutout cone.
- Cone direction: Assume forward-facing initially; update based on movement direction later if needed.
- Tile size: 32px; range in tiles (e.g., 4 tiles radius).
- Refer to `packages/client/app/components/PhaserGame.tsx` and Phaser docs for masks: https://phaser.io/phaser3/devlog/111
- Follow code style: TypeScript, 2-space indentation, camelCase, early returns, descriptive names like updateFlashlightVisibility.
- Accessibility: Ensure visibility doesn't affect keyboard navigation; add ARIA for screen readers if needed (e.g., announce visible area changes).
- Defer shared visibility and treasure detection to later stories.

### Testing
- Test file location: `packages/client/test/PhaserGame.test.tsx`
- Test standards: Jest with Phaser mocks (simulate player positions, verify mask updates, check visible/invisible tiles).
- Ensure tests cover cone calculation, dynamic updates, edge cases like walls blocking view.

## Change Log
| Date       | Version | Description              | Author |
|------------|---------|--------------------------|--------|
| 2025-09-10 | 1.0     | Initial draft of story.  | Full Stack Developer |
| 2025-09-10 | 1.1     | Implemented visibility cone with fog and light mask in PhaserScene; added tests. | Full Stack Developer |

## Dev Agent Record
### Debug Log References
- None.

### Completion Notes
- Visibility implemented with grid-based cone calculation using angle checks from player direction; fog overlay drawn full black, light mask fills visible tiles white; updates on every movement and position sync; cone range 4 tiles, 60 degrees; always includes player tile; edge cases handled by bounds checks in compute; tests verify computation, updates on move/position change, clear calls.

### Agent Model Used
- openrouter/sonoma-sky-alpha

### File List
- packages/client/app/components/PhaserGame.tsx (modified: added direction, fog/light props, computeVisibleTiles, updateVisibility, integrated in create/update/updatePlayerPosition)
- packages/client/test/PhaserGame.test.tsx (modified: enhanced mocks, added visibility tests)