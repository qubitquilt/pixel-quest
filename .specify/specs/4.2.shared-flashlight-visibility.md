# Story 4.2: Shared Flashlight Visibility

## Status
- [x] Draft
- [x] Approved
- [x] In Progress
- [x] Review
- [x] Done

## Story
**As a** player,
**I want** my ray-traced flashlight cone to be visible to other players, and I want to see theirs,
**so that** we have shared ray-traced visibility on the map with proper occlusion during gameplay.

## Acceptance Criteria
1. Each player's position and direction are synced to server on movement; server broadcasts to all clients via Colyseus state.
2. Client computes ray-traced cones for all players from synced pos/dir, casting rays per player for occlusion.
3. Client renders multiple visibility polygons: own cone full reveal, others' cones tinted/semi-transparent for distinction.
4. Visibility updates in real-time for all cones on state changes, with union of polygons for composite light mask.
5. Cones overlap correctly: union of all visible polygons determines revealed area, respecting individual occlusions.
6. Performance: Efficient ray casting (e.g., 80 rays/player, batched), smooth for 4+ players at 60 FPS.
7. Local cone prioritizes in rendering order (own first, then others' layered).

## Tasks / Subtasks
- [x] **Server:** Extend MazeRaceRoom state schema for players[].direction; update on move message and broadcast via Colyseus.
- [x] **Server:** Direction syncs automatically on player update; no explicit cone schema needed (client computes from pos/dir).
- [x] **Client:** In PhaserGame/MazeScene, use room.state.onChange to trigger re-compute on any player pos/dir change.
- [x] **Client:** Extend updateFlashlightMask: compute ray-traced polygon for own player, then for each other player; union polygons for composite light fill or layer multiple.
- [x] **Client:** Handle overlaps: Union intersection points or composite fill across polygons before masking fog.
- [x] **Client:** Visual diff: Own polygon full opacity white tint, others semi-transparent gray; draw in separate passes.
- [x] **Client:** Unit tests: Mock multi-player state, verify per-player ray calls, union polygon logic, multiple fillPoints.
- [x] **E2E:** Extend gameplay.spec.ts: Multi-join, move players, verify shared polygons/occlusions in screenshots.

## Dev Notes
- Builds on 4.1: Reuse ray-tracing logic from updateFlashlightMask for each player, computing polygons client-side from synced pos/dir.
- Colyseus: PlayerState includes direction; onChange for players Map triggers full visibility recompute (efficient for small player count).
- Phaser: Single light Graphics for union polygon (collect all intersection points, convex hull if needed), or multiple layered for visual diff; fog mask on composite.
- Direction sync: Already in 3.1/4.1 movement; client rays per player use their direction angle.
- Range/Angle: 400px/80 degrees, 80 rays per cone; shared params across players.
- Refer to packages/client/lib/colyseus.ts for room setup, packages/server/rooms/MazeRaceRoom.ts for state; example docs/examples/flashlight-implementation.html for multi-poly extension.
- Follow style: TS, 2-space, camelCase, early returns (e.g., if(!otherPlayers.size) return), handleKeyDown prefix.
- Accessibility: Announce shared visibility changes via ARIA live region (e.g., "Player2 cone updated, new areas revealed").
- Defer win/treasure to 4.3; assume no blocking.

### Testing
- Test file location: `packages/client/test/PhaserGame.test.tsx`
- Test standards: Jest mocks for Colyseus multi-state, Phaser walls; verify per-player ray casting, multi-polygon unions, layered fills, updates onChange.
- Cover: Single vs multi-player, cone overlaps/occlusions, edge (off-screen rays clipped), perf (ray batching <16ms/frame for 4 players).

## Change Log
| Date       | Version | Description              | Author |
|------------|---------|--------------------------|--------|
| 2025-09-17 | 1.0     | Initial draft of story.  | BMad Orchestrator |
| 2025-09-17 | 1.2     | Refactored to shared ray-traced visibility, multi-polygon union with occlusion, visual diff, updated tests. | BMad Orchestrator |

## Dev Agent Record
### Debug Log References
- None.

### Completion Notes
- Shared ray-traced visibility implemented: per-player rays/polygons computed from synced pos/dir, union for light mask, layered tints for visual diff (own white, others gray); real-time on state changes; occlusion respected per cone; tests pass (unit for multi-rays/union, E2E screenshots verify reveals); perf ok for 4+ players (<16ms recompute).

### Agent Model Used
- openrouter/sonoma-sky-alpha

### File List
- packages/server/rooms/MazeRaceRoom.ts (modified: direction sync in handleMove)
- packages/client/app/components/PhaserGame.tsx (modified: multi-player ray-tracing in updateFlashlightMask, polygon union/layering, onChange trigger)
- packages/client/test/PhaserGame.test.tsx (added: multi-player ray mocks, polygon union tests, visual diff verification)
- packages/client/e2e/gameplay.spec.ts (extended: multi-player movement, screenshot assertions for shared polygons/occlusions, perf checks)